{% extends 'base.html' %}

{% block bodyblock %}
<!-- 12 -->
<div class="container">
    <br><br>
    <h3 class="display-6"> Reproducibility for verifiable, corroborable, trustworthy, credible, reliable, traceable, correctly rewarded scientific research</h3>
    <br>
    <p>
        The following calculator is a simple tool to quantitatively have the percentage of reproducibility that a developed Application achieves.
    </p>

    <div class="row">
        <div class="col">
            <title>Applicaction Reproducibility Checklist</title>
            <style>
                table {
                    border-collapse: collapse;
                    width: 100%;
                }
                th, td {
                    border: 1px solid #ddd;
                    padding: 8px;
                    text-align: left;
                }
                th {
                    background-color: #f2f2f2;
                }
                #buttons {
                    margin-top: 20px;
                }
                #buttons button {
                    margin-right: 10px;
                }
                #certificationHash {
                    margin-top: 20px;
                    font-weight: bold;
                    color: green;
                }
                #badge {
                    margin-top: 20px;
                }
                #badge img {
                    width: 100px;
                    height: auto;
                }
            </style>

            <!-- Tabla de checklist -->
            <table id="data-table">
                <thead>
                    <tr>
                        <th>Attribute</th>
                        <th>Description</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Version Control</td>
                        <td>Source code, and data should be managed using a version control system to track changes over time.</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="0"></td>
                    </tr>
                    <tr>
                        <td>Associated Publication</td>
                        <td>The article gives all the necessary information to obtain an equivalent implementation (pseudocodes, mathematical details)</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="1"></td>
                    </tr>
                    <tr>
                        <td>Automation</td>
                        <td>Reproducibility procedures should be automated as much as possible to reduce human error.</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="2"></td>
                    </tr>
                    <tr>
                        <td>Containerization</td>
                        <td>The environment is controlled. The procedure to re-create the environment is provided, and it is complete</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="3"></td>
                    </tr>
                    <tr>
                        <td>Documentation</td>
                        <td>Detailed documentation should accompany the application, explaining its purpose, usage, and inner workings. Installation instructions are complete</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="4"></td>
                    </tr>
                    <tr>
                        <td>Data Provenance</td>
                        <td>Data sources and transformations should be well-documented to trace the origin of results</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="5"></td>
                    </tr>
                    <tr>
                        <td>Validation</td>
                        <td>Validation of the application against known datasets or analytical solutions to ensure correctness.</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="6"></td>
                    </tr>
                    <tr>
                        <td>Persistent Immutable Identifier</td>
                        <td>Assign a persistent immutable identifier to the application to facilitate citation and reference. (e.g, SWHID, DOI)</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="7"></td>
                    </tr>
                    <tr>
                        <td>Use of Open Repositories</td>
                        <td>Utilize open repositories for storing source code, data, and documentation to enable easy access and collaboration.</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="8"></td>
                    </tr>
                    <tr>
                        <td>Open Community Standards</td>
                        <td>Adhere to community standards and best practices for data formatting, analysis, and reporting.</td>
                        <td><input type="checkbox" class="percentage-checkbox" data-value="10" data-index="9"></td>
                    </tr>
                </tbody>
            </table>

            <div>Total App Reproducibility Percentage: <span id="total">0%</span></div>

            <!-- Contenedor para el gráfico de radar -->
            <canvas id="radialChart" width="100" height="100"></canvas>

            <!-- Botones para certificar e imprimir -->
            <div id="buttons">
                <button id="certifyButton" class="btn btn-success">Certify</button>
                <button id="printButton" class="btn btn-primary">Print</button>
            </div>

            <!-- Hash de certificación -->
            <div id="certificationHash">Certification Hash: <span id="hashValue">Not certified yet</span></div>

            <!-- Insignia de certificación -->
            <div id="badge"></div>

            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                document.addEventListener("DOMContentLoaded", function() {
                    const checkboxes = document.querySelectorAll('.percentage-checkbox');
                    const totalSpan = document.getElementById('total');
                    const ctx = document.getElementById('radialChart').getContext('2d');
                    const hashValueSpan = document.getElementById('hashValue');
                    const badgeDiv = document.getElementById('badge');
                    let total = 0;

                    // Datos iniciales del gráfico radial
                    let radarData = Array(10).fill(0); // 10 atributos, todos empezando en 0.

                    // Crear el gráfico de radar
                    const radialChart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: [
                                'Version Control',
                                'Associated Publication',
                                'Automation',
                                'Containerization',
                                'Documentation',
                                'Data Provenance',
                                'Validation',
                                'Persistent ID',
                                'Open Repositories',
                                'Community Standards'
                            ],
                            datasets: [{
                                label: 'Reproducibility Percentage',
                                data: radarData,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 2,
                                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                            }]
                        },
                        options: {
                            scale: {
                                ticks: {
                                    beginAtZero: true,
                                    max: 10
                                }
                            }
                        }
                    });

                    checkboxes.forEach(function(checkbox) {
                        checkbox.addEventListener('change', function() {
                            total = 0;
                            radarData = Array(10).fill(0); // Reiniciar los datos del radar

                            checkboxes.forEach(function(cb) {
                                if (cb.checked) {
                                    total += parseFloat(cb.getAttribute('data-value'));
                                    const index = cb.getAttribute('data-index');
                                    radarData[index] = parseFloat(cb.getAttribute('data-value')); // Actualizar el dato correspondiente al eje
                                }
                            });

                            if (total > 100) {
                                checkbox.checked = false;
                                alert("The total percentage cannot exceed 100%");
                            } else {
                                totalSpan.textContent = total + "%";
                                radialChart.data.datasets[0].data = radarData; // Actualizar los datos del gráfico
                                radialChart.update(); // Actualizar el gráfico
                            }
                        });
                    });

                    // Función para generar un hash usando el estado de los checkboxes
                    async function generateHash() {
                        const values = Array.from(checkboxes).map(cb => cb.checked ? '1' : '0').join('');
                        const encoder = new TextEncoder();
                        const data = encoder.encode(values);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        return hashHex;
                    }

                    // Función para mostrar la insignia de acuerdo con el porcentaje
                    function showBadge(percentage) {
                        badgeDiv.innerHTML = ''; // Limpiar cualquier badge anterior
                        let badgeImg = document.createElement('img');
                        
                        if (percentage >= 40 && percentage < 60) {
                            badgeImg.src = '/static/images/bronze.PNG';
                            badgeImg.alt = 'Bronze Badge';
                        } else if (percentage >= 60 && percentage < 80) {
                            badgeImg.src = '/static/images/silver.PNG';
                            badgeImg.alt = 'Silver Badge';
                        } else if (percentage >= 80 && percentage <= 100) {
                            badgeImg.src = '/static/images/gold.PNG';
                            badgeImg.alt = 'Gold Badge';
                        }

                        if (badgeImg.src) {
                            badgeDiv.appendChild(badgeImg);
                        }
                    }

                    // Función para certificar
                    document.getElementById('certifyButton').addEventListener('click', async function() {
                        const hash = await generateHash();
                        hashValueSpan.textContent = hash;
                        showBadge(total);
                        alert('Certification successful! Hash generated: ' + hash);
                    });

                    // Función para imprimir la tabla, gráfica y el hash
                    document.getElementById('printButton').addEventListener('click', function() {
                        window.print();
                    });
                });
            </script>

        </div>
    </div>
</div>
{% endblock %}
